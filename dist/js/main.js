function initMap(){map=new google.maps.Map(document.getElementById("map"),{center:nycLatLng,zoom:13}),placesService=new google.maps.places.PlacesService(map),viewModel.initializeListItems()}var map,placesService,searchBox,inputBox=document.getElementById("pac-input"),nycLatLng={lat:40.7481831,lng:-74.0070031},ViewModel=function(){var e=this;e.listItems=ko.observableArray([]),e.markers=[],e.unfilteredPlaceList=[],e.currentInfoWindow=null,e.currentFilterText=ko.observable(""),e.currentFilterText.subscribe(function(n){if(""===n.trim())e.setListItems(e.unfilteredPlaceList);else{var t=e.filterList(n);e.setListItems(t)}}),e.setListItems=function(n){e.listItems.removeAll();for(var t=0;t<e.markers.length;++t)e.markers[t].setMap(null);e.markers=[];var r=function(){e.handleListElementOrMarkerClick(this)};for(t=0;t<n.length;++t)if(-1!=$.inArray("restaurant",n[t].types)||-1!=$.inArray("cafe",n[t].types)||-1!=$.inArray("bar",n[t].types)||-1!=$.inArray("bakery",n[t].types)){e.listItems.push(n[t]);var i=new google.maps.Marker({position:n[t].geometry.location,map:map,title:n[t].geometry.name,placeData:n[t],iAmAMarker:!0});i.addListener("click",r),e.markers.push(i)}},e.filterList=function(n){for(var t=[],r=n.toLowerCase().split(" "),i=0;i<e.unfilteredPlaceList.length;++i)for(var a=e.unfilteredPlaceList[i],o=a.name.toLowerCase(),s=0;s<r.length;++s){var l=r[s];if(-1!=o.indexOf(l)){t.push(a);break}}return t},e.initializeListItems=function(){var n={query:"coffee in Manhatten, NYC",bounds:map.getBounds()};placesService.textSearch(n,function(n){e.unfilteredPlaceList=n,e.setListItems(n)})},e.handleListElementOrMarkerClick=function(n){var t,r;if(n.iAmAMarker)t=n.placeData,r=n;else{t=n;for(var i=0;i<e.markers.length;++i)if(t.id==e.markers[i].placeData.id){r=e.markers[i];break}}if(null===e.currentInfoWindow&&(e.currentInfoWindow=new google.maps.InfoWindow),null===e.currentInfoWindow||e.currentInfoWindow.marker!=r){null!==e.currentInfoWindow&&(e.currentInfoWindow.setMarker=null),e.currentInfoWindow.marker=r,e.currentInfoWindow.setContent("<div>"+t.name+"</div><p>"+t.formatted_address+"</p>"),e.currentInfoWindow.open(map,r),e.currentInfoWindow.addListener("closeclick",function(){e.currentInfoWindow.setMarker=null});var a="https://api.nytimes.com/svc/search/v2/articlesearch.json";a+="?"+$.param({"api-key":"7112833395c14519bee52c0a452a553d",q:t.name});var o="<h5>New York Times Related Article</h5>";$.ajax({url:a,method:"GET"}).done(function(n){if(docs=n.response.docs,docs.length>0){if(null!==docs[0].snippet&&null!==docs[0].web_url){var t=o;t+='<a href="'+docs[0].web_url+'">'+docs[0].headline.main+"</a>",t+="<p>"+docs[0].snippet+"</p>",e.currentInfoWindow.setContent(e.currentInfoWindow.content+t)}}else e.currentInfoWindow.setContent(e.currentInfoWindow.content+o+"<p>No NYTimes articles found.</p>")}).fail(function(n){e.currentInfoWindow.setContent(e.currentInfoWindow.content+o+"<p>Could not reach NYTimes server.</p>")})}r.setAnimation(google.maps.Animation.DROP)}},viewModel=new ViewModel;ko.applyBindings(viewModel);