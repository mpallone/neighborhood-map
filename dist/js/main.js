function initMap(){map=new google.maps.Map(document.getElementById("map"),{center:nycLatLng,zoom:13}),placesService=new google.maps.places.PlacesService(map),viewModel.initializeListItems()}function handleGoogleMapsFailure(){alert("Failed to load Google map!")}var map,placesService,searchBox,nycLatLng={lat:40.7481831,lng:-74.0070031},ViewModel=function(){var e=this;e.listItems=ko.observableArray([]),e.markerDict={},e.unfilteredPlaceList=[],e.currentInfoWindow=null,e.currentFilterText=ko.observable(""),e.currentFilterText.subscribe(function(t){if(""===t.trim())e.setListItems(e.unfilteredPlaceList);else{var n=e.filterList(t);e.setListItems(n)}}),e.setListItems=function(t){e.listItems.removeAll();for(var n in e.markerDict)e.markerDict.hasOwnProperty(n)&&e.markerDict[n].setVisible(!1);for(i=0;i<t.length;++i)-1==$.inArray("restaurant",t[i].types)&&-1==$.inArray("cafe",t[i].types)&&-1==$.inArray("bar",t[i].types)&&-1==$.inArray("bakery",t[i].types)||(e.listItems.push(t[i]),e.markerDict[t[i].id].setVisible(!0));e.currentInfoWindow.close()},e.filterList=function(t){for(var n=[],i=t.toLowerCase().split(" "),r=0;r<e.unfilteredPlaceList.length;++r)for(var o=e.unfilteredPlaceList[r],a=o.name.toLowerCase(),s=0;s<i.length;++s){var c=i[s];if(-1!=a.indexOf(c)){n.push(o);break}}return n},e.initializeListItems=function(){var t={query:"coffee in Manhatten, NYC",bounds:map.getBounds()};placesService.textSearch(t,function(t){e.unfilteredPlaceList=t;for(var n=function(){e.handleListElementOrMarkerClick(this)},i=0;i<t.length;++i){var r=new google.maps.Marker({position:t[i].geometry.location,map:map,title:t[i].geometry.name,placeData:t[i],iAmAMarker:!0});r.addListener("click",n),e.markerDict[t[i].id]=r}e.setListItems(t)}),e.currentInfoWindow=new google.maps.InfoWindow,e.currentInfoWindow.close()},e.handleListElementOrMarkerClick=function(t){var n,i;if(t.iAmAMarker?(n=t.placeData,i=t):(n=t,i=e.markerDict[n.id]),map.panTo(i.getPosition()),map.setCenter(i.getPosition()),e.currentInfoWindow.marker!=i){e.currentInfoWindow.marker=i,e.currentInfoWindow.setContent("<div>"+n.name+"</div><p>"+n.formatted_address+"</p>"),e.currentInfoWindow.open(map,i),e.currentInfoWindow.addListener("closeclick",function(){e.currentInfoWindow.setMarker=null});var r="https://api.nytimes.com/svc/search/v2/articlesearch.json";r+="?"+$.param({"api-key":"7112833395c14519bee52c0a452a553d",q:n.name});var o="<h5>New York Times Related Article</h5>";$.ajax({url:r,method:"GET"}).done(function(t){if(docs=t.response.docs,docs.length>0){if(null!==docs[0].snippet&&null!==docs[0].web_url){var n=o;n+='<a href="'+docs[0].web_url+'">'+docs[0].headline.main+"</a>",n+="<p>"+docs[0].snippet+"</p>",e.currentInfoWindow.setContent(e.currentInfoWindow.content+n)}}else e.currentInfoWindow.setContent(e.currentInfoWindow.content+o+"<p>No NYTimes articles found.</p>")}).fail(function(t){e.currentInfoWindow.setContent(e.currentInfoWindow.content+o+"<p>Could not reach NYTimes server.</p>")})}i.setAnimation(google.maps.Animation.DROP)}},viewModel=new ViewModel;ko.applyBindings(viewModel);