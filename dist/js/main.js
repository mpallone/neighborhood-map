function initMap(){map=new google.maps.Map(document.getElementById("map"),{center:nycLatLng,zoom:13}),placesService=new google.maps.places.PlacesService(map),viewModel.initializeListItems()}var map,placesService,searchBox,nycLatLng={lat:40.7481831,lng:-74.0070031},ViewModel=function(){var e=this;e.listItems=ko.observableArray([]),e.markerDict={},e.unfilteredPlaceList=[],e.currentInfoWindow=null,e.currentFilterText=ko.observable(""),e.currentFilterText.subscribe(function(n){if(""===n.trim())e.setListItems(e.unfilteredPlaceList);else{var t=e.filterList(n);e.setListItems(t)}}),e.setListItems=function(n){e.listItems.removeAll();for(var t in e.markerDict)e.markerDict.hasOwnProperty(t)&&e.markerDict[t].setVisible(!1);for(i=0;i<n.length;++i)-1==$.inArray("restaurant",n[i].types)&&-1==$.inArray("cafe",n[i].types)&&-1==$.inArray("bar",n[i].types)&&-1==$.inArray("bakery",n[i].types)||(e.listItems.push(n[i]),e.markerDict[n[i].id].setVisible(!0));null!==e.currentInfoWindow&&e.currentInfoWindow.close()},e.filterList=function(n){for(var t=[],r=n.toLowerCase().split(" "),i=0;i<e.unfilteredPlaceList.length;++i)for(var o=e.unfilteredPlaceList[i],a=o.name.toLowerCase(),s=0;s<r.length;++s){var c=r[s];if(-1!=a.indexOf(c)){t.push(o);break}}return t},e.initializeListItems=function(){var n={query:"coffee in Manhatten, NYC",bounds:map.getBounds()};placesService.textSearch(n,function(n){e.unfilteredPlaceList=n;for(var t=function(){e.handleListElementOrMarkerClick(this)},r=0;r<n.length;++r){var i=new google.maps.Marker({position:n[r].geometry.location,map:map,title:n[r].geometry.name,placeData:n[r],iAmAMarker:!0});i.addListener("click",t),e.markerDict[n[r].id]=i}e.setListItems(n)})},e.handleListElementOrMarkerClick=function(n){var t,r;if(n.iAmAMarker?(t=n.placeData,r=n):(t=n,r=e.markerDict[t.id]),null===e.currentInfoWindow&&(e.currentInfoWindow=new google.maps.InfoWindow),null===e.currentInfoWindow||e.currentInfoWindow.marker!=r){null!==e.currentInfoWindow&&(e.currentInfoWindow.setMarker=null),e.currentInfoWindow.marker=r,e.currentInfoWindow.setContent("<div>"+t.name+"</div><p>"+t.formatted_address+"</p>"),e.currentInfoWindow.open(map,r),e.currentInfoWindow.addListener("closeclick",function(){e.currentInfoWindow.setMarker=null});var i="https://api.nytimes.com/svc/search/v2/articlesearch.json";i+="?"+$.param({"api-key":"7112833395c14519bee52c0a452a553d",q:t.name});var o="<h5>New York Times Related Article</h5>";$.ajax({url:i,method:"GET"}).done(function(n){if(docs=n.response.docs,docs.length>0){if(null!==docs[0].snippet&&null!==docs[0].web_url){var t=o;t+='<a href="'+docs[0].web_url+'">'+docs[0].headline.main+"</a>",t+="<p>"+docs[0].snippet+"</p>",e.currentInfoWindow.setContent(e.currentInfoWindow.content+t)}}else e.currentInfoWindow.setContent(e.currentInfoWindow.content+o+"<p>No NYTimes articles found.</p>")}).fail(function(n){e.currentInfoWindow.setContent(e.currentInfoWindow.content+o+"<p>Could not reach NYTimes server.</p>")})}r.setAnimation(google.maps.Animation.DROP)}},viewModel=new ViewModel;ko.applyBindings(viewModel);