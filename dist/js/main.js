function initMap(){map=new google.maps.Map(document.getElementById("map"),{center:nycLatLng,zoom:13}),placesService=new google.maps.places.PlacesService(map),viewModel.initializeListItems()}function handleGoogleMapsFailure(){alert("Failed to load Google map!")}var map,placesService,searchBox,nycLatLng={lat:40.7481831,lng:-74.0070031},ViewModel=function(){var e=this;e.listItems=ko.observableArray([]),e.markerDict={},e.unfilteredPlaceList=[],e.currentInfoWindow=null,e.currentFilterText=ko.observable(""),e.currentFilterText.subscribe(function(t){if(""===t.trim())e.setListItems(e.unfilteredPlaceList);else{var n=e.filterList(t);e.setListItems(n)}}),e.setListItems=function(t){e.listItems.removeAll();for(var n in e.markerDict)e.markerDict.hasOwnProperty(n)&&e.markerDict[n].setVisible(!1);for(var r=0;r<t.length;++r)-1==$.inArray("restaurant",t[r].types)&&-1==$.inArray("cafe",t[r].types)&&-1==$.inArray("bar",t[r].types)&&-1==$.inArray("bakery",t[r].types)||(e.listItems.push(t[r]),e.markerDict[t[r].id].setVisible(!0));e.currentInfoWindow.close()},e.filterList=function(t){for(var n=[],r=t.toLowerCase().split(" "),i=0;i<e.unfilteredPlaceList.length;++i)for(var o=e.unfilteredPlaceList[i],a=o.name.toLowerCase(),s=0;s<r.length;++s){var c=r[s];if(-1!=a.indexOf(c)){n.push(o);break}}return n},e.initializeListItems=function(){var t={query:"coffee in Manhatten, NYC",bounds:map.getBounds()};placesService.textSearch(t,function(t){e.unfilteredPlaceList=t;for(var n=function(){e.handleListElementOrMarkerClick(this)},r=0;r<t.length;++r){var i=new google.maps.Marker({position:t[r].geometry.location,map:map,title:t[r].geometry.name,placeData:t[r],iAmAMarker:!0});i.addListener("click",n),e.markerDict[t[r].id]=i}e.setListItems(t)}),e.currentInfoWindow=new google.maps.InfoWindow,e.currentInfoWindow.close()},e.handleListElementOrMarkerClick=function(t){var n,r;if(t.iAmAMarker?(n=t.placeData,r=t):(n=t,r=e.markerDict[n.id]),map.panTo(r.getPosition()),map.setCenter(r.getPosition()),e.currentInfoWindow.marker!=r){e.currentInfoWindow.marker=r,e.currentInfoWindow.setContent("<div>"+n.name+"</div><p>"+n.formatted_address+"</p>"),e.currentInfoWindow.open(map,r),e.currentInfoWindow.addListener("closeclick",function(){e.currentInfoWindow.setMarker=null});var i="https://api.nytimes.com/svc/search/v2/articlesearch.json";i+="?"+$.param({"api-key":"7112833395c14519bee52c0a452a553d",q:n.name});var o="<h5>New York Times Related Article</h5>";$.ajax({url:i,method:"GET"}).done(function(t){if(docs=t.response.docs,docs.length>0){if(null!==docs[0].snippet&&null!==docs[0].web_url){var n=o;n+='<a href="'+docs[0].web_url+'">'+docs[0].headline.main+"</a>",n+="<p>"+docs[0].snippet+"</p>",e.currentInfoWindow.setContent(e.currentInfoWindow.content+n)}}else e.currentInfoWindow.setContent(e.currentInfoWindow.content+o+"<p>No NYTimes articles found.</p>")}).fail(function(t){e.currentInfoWindow.setContent(e.currentInfoWindow.content+o+"<p>Could not reach NYTimes server.</p>")})}r.setAnimation(google.maps.Animation.DROP)}},viewModel=new ViewModel;ko.applyBindings(viewModel);